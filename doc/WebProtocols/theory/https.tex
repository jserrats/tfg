\section{HTTPS}

HTTPS is a protocol that extends the function of HTTP adding a layer of security, adapted to modern times. The bidirectional connection is encrypted using TLS (Transport Layer Security).
When TLS is used correctly, the connection between a user and a client is
\begin{itemize}
	\item \textbf{Private} Symmetric cryptography is used by both parties to transmit the data. The keys used are generated every session in a way that even if an eavesdropper has been supervising the  whole conversation cannot obtain said keys.
	\item \textbf{Authentication} The server can prove their identity using public key cryptography.
	\item \textbf{Integrity} The connection is considered reliable since every message contains an integrity check that 
\end{itemize}
When connecting to a site that uses https, the URL begins with \textbf{https://} and the default port is \textbf{443} instead of 80


\subsubsection{TLS Handshake}
Before any data is transmitted, a TLS Handshake is performed. The goal of this handshake is to privately exchange the keys that will be used to encrypt the transmission and to authenticate the server. The protocol allows for the authentication of both the server and the client, but in this explanation we'll omit the client authentication as it is not used in usual HTTPS connections. 

\begin{figure}[htb]
	\begin{centering}
		\includegraphics[width=0.7\columnwidth]{\securitydir/WebProtocols/figures/tls}
		\par
	\end{centering}
	\caption{\label{fig:tls} TLS handshake}
\end{figure}



\subsubsection{Public key certificates}
A public key certificate is an electronic document that the server uses to prove the ownership of a public key (therefore, its identity). Valid certificates have to be signed by a Certificate Authority (CA). A CA is a trusted third party (usually a company) that signs the certificates of the clients with its own certificate. Because it is not possible to have the certificates of all the CA that exist, their certificate is signed by another, called the \textbf{Root Certificate}. This root certificate is obtained when installing the operating system or the web browser. With this system we've established a \textbf{chain of trust}. When we visit a website we download its certificate. Then we check the CA that has issued it, and so on until we reach the root certificate. If the root certificate is found within the trusted by our system, we'll assume the certificate is valid, and that the server we are connecting to really owns this public key. 

\begin{figure}[htb]
	\begin{centering}
		\includegraphics[width=0.7\columnwidth]{\securitydir/WebProtocols/figures/chain}
		\par
	\end{centering}
	\caption{\label{fig:chain} Chain of trust}
\end{figure}

A certificate contains the following information:
\begin{itemize}
	\item Owner's name (in a web context it would be the domain name)
	\item Owner's public key
	\item Name of the CA that has issued this certificate
	\item CA signature of the certificate.
	\item Valid time.
\end{itemize}

% foto del browser amb certificat


% hsts

\subsection{HTTP Strict Transport Security (HSTS)} 
HSTS is a mechanism used by the web servers to tell browsers that they should only interact with them using HTTPS. When HTSTS is enabled on a server, the server responds the requests with the header \textbf{Strict-Transport-Security} indicating a time period in seconds on which the browser should only use HTTPS to connect to that domain. Browsers should do the following when contacting a HSTS enabled domain.
\begin{itemize}
	\item Always connect via https. If the user introduces a link that begins with http://, automatically transform it to https. The browser should never attempt to do any connection via http.
	\item If the certificate is not valid (expired, self signed, etc), the browser should terminate the connection immediately.
\end{itemize}

To enable HSTS on a website, the server should respond to any request with the following header specifying a TTL in seconds.
\textbf{Strict-Transport-Security: max-age=31536000}
When a browser gets this header, it automatically applies the standard for this site during the specified time.

HSTS can also be \textbf{preloaded.} This means that browser are installed with a default list of domains that have requested to be included in it. If a domain is in this list, the browser will apply HSTS by default, without waiting to receive any header. This is done because even though HSTS greatly improves security, the first connection is still vulnerable.

The mechanism is used to protect the connection from \textbf{downgrade attacks}. If a malicious agent could poison the dns responses for a user in order to point them to a server that he controls, he could be able to use a proxy that establishes a http connection to the user and a https connection to the original server. The user would only see that the connection is https, but for most users that would not raise any suspicion.

\begin{figure}[htb]
	\begin{centering}
		\includegraphics[width=0.7\columnwidth]{\securitydir/WebProtocols/figures/hsts}
		\par
	\end{centering}
	\caption{\label{fig:hsts} Downgrade attack without HSTS enabled}
\end{figure}

If HSTS was enabled in this scenario, the browser would refuse to connect to the proxy as the connection was plain http. 